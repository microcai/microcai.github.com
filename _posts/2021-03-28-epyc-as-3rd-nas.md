---
layout: post
title: epyc deployed
tags: [NAS, EPYC]
---

去年的 [这篇文章](/2020/12/18/nas-upgraded.html) 里我受够了嵌入式 ATOM 处理器羸弱的性能而斥巨资购买了 锐龙 5600X 作为新的NAS机器的处理器。然而好景不长，这个新NAS才服役不到4个月，就被我[嫌弃了](/2021-03-07-pcie-shortage-problem.html)。在这篇文章的结尾，我提到了 *EPYC 的精髓在单路* 这句话。
这竟是我抛弃第二台NAS的导火索。

起初，我购买 NAS 只是为了做一个下载机。开个 Download Station 下下高清的片子。后来我希望它能承载更多的任务，然而 A53 + 512M 的平台，无论如何无法承载更多。于是就有了第一台NAS。原谅我甚至不把那台DS216j看成第一台NAS。

最初第一台 NAS 没有远见，机器毫无扩展性。甚至初期只用4个盘。但是好歹也有了大容量。也能突破千兆的瓶颈了。
用了一阵子后，受不了 atom 的性能而进行了更新。

第二台NAS性能非常棒。毕竟 zen3 架构，单核南波万。也正是因为他巨大的性能提升，导致我不只是把它当NAS了。他成了我的私人服务器。不仅仅运行 samba 共享，还运行多媒体服务，还运行 nextcloud 私人备份，当然跑 bt 下载也是少不了的。

除此之外，他还对我公司的线上数据进行热备。算是一份异地灾备。
然后，还运行了多个区块链的节点 —— 什么比特币，以太坊，波场币，统统都跑一个节点看看。

这下完犊子了。由于使用的是 ITX 主板，只有2条内存插槽，导致内存最大就被限制到了64G。运行了那么多服务，内存开销自然是小不了。于是时不时的就看到 OOM 崩溃日志。

加了 SWAP 后算是缓解了OOM。但是 iostat 可以看到 swap 文件长期保持在 300M/s 的读取速度 —— 不用说，就是内存不够了，被大量的 drop 掉，然后又马上访问于是又得 swap in 。

内存不足，是一件迫在眉睫的事情。我至少需要 128G 的内存！ 换成 matx 的主板固然可以低成本解决问题 —— 但是，128G 要还是不够用了咋办？ 这可是 PC 平台 4条 DIMM 的极限容量了。再增加容量就只能上 64G 单条了。而64G单条又必须是Registered ECC内存，Unbuffered ECC不论如何都只有32G，再大没有了。

除了内存不足，还有一个窘境是 pcie 通道不足。目前我已经把 5600X 的全部 pcie 通道都利用上了，可是有好几个淘汰下来的 120G 的 NVMe 我也想插上发挥余热！

一不做二不休，干脆就上 epyc 平台把！7条满血的 PCIe 插槽！8条支持 RECC 的 DIMM！而且这些 pcie 槽还都支持拆分！
意味着买几个廉价的 <img src="/images/hyper_m2_x4.jpg" class="inline-img" style="height: 8em; display:inline-flex; width: auto; "> 转接卡就能插上4 7 28个 nvme 盘！

经过2周的采购和等待，最后组装完成了第三台 NAS

<img src="/images/epyc_nas.jpg" >

配置清单为 

|       |                                                          |
|---------|--------------------------------------------------------|
|主板    | ASRock EYCD8T                                             |
|CPU     | EPYC 7282 ( 7302P 赶上缺货，改用 7282 )                   |
|内存     | 三星 RECC DDR4-2933 64G * 4 条                           |
|散热器   | 普通的 SP3 散热器，暴力风扇拆掉丢垃圾桶，换猫头鹰 NF-A9      |
|---------|--------------------------------------------------------|


内存之所以上4条，没有插满8通道，一来是因为 7282 毕竟才区区 16核，用不到8通道的带宽。而来未来可以再买4条 64G 升级成 512G 内存。

好了，终于可以插上 8个 NVMe 盘了：
<img src="/images/8nvme.png" >

