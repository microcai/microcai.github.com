<!DOCTYPE html>
<html>
  <head>
    <title>如何自动获取网络变化通知 - Litao.Me</title>
    <link rel="shortcut icon" href="favicon.ico" />
    
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <link rel="stylesheet" media="screen" href="/stylesheets/screen.css" type="text/css" />
    <link rel="stylesheet" href="/stylesheets/embed.css"/>
    
    
  </head>
  <body>
    <div id="page">
      <div id="header">
        <a href="/"><h1>Litao.Me</h1></a>
      </div>
      <div id="body">
        <h1>如何自动获取网络变化通知</h1>
        <div class="postdate">Posted on 23 Apr 2012</div>
<div class="post">
<p>当我们把网线插到计算机上时，WINDOWS任务栏的托盘图标都会更改相应的网络图标，拔掉也会有相应的处理。一直都对这个机制感兴趣，却不知道如何做，而且公司的某个产品也需要这么一个功能。昨天在家测试某个程序的时候，发现了其中一个线程的栈中有一个叫wininet!CheckForNetworkChange的函数，IDA分析了WINNET.DLL后，有了本文。</p>

<p>微软在WINDOWS VISTA之后提供了一个叫NLA(Network List Manager API)的接口，用于获取网络状态变化通知的一个接口。以COM技术实现。
主要导出的COM接口如下：</p>

<pre>
IEnumNetworkConnections
IEnumNetworks
INetwork
INetworkConnection
INetworkConnectionEvents
INetworkEvents
INetworkListManager
INetworkListManagerEvents
</pre>


<p>其中INetworkListManager是一个根对象，可以获取计算机是否连接到因特网(INetworkListManager->get_IsConnectedToInternet)。还可以查询有哪些可用的网络和连接.更关键的是INetworkListManagerEvents和INetworkEvents两个类。这两个类在MSDN文档里的描述如下：</p>

<pre>
is a message sink interface that a client implements to get overall machine state related events.
</pre>


<p>也就是说我们要自己实现这两个类。而回调的方式是通过COM技术中特有的机制IConnectionPoint来搞定。实现方式如下：</p>

<div id="gist-3747803" class="gist">
    <div class="gist-file">
          <div class="gist-data gist-syntax">
              <div class="gist-highlight"><pre><div class="line" id="LC1"><span class="k">class</span> <span class="nc">CNetworkListManagerEvent</span> <span class="o">:</span> <span class="k">public</span> <span class="n">INetworkListManagerEvents</span></div><div class="line" id="LC2"><span class="p">{</span></div><div class="line" id="LC3"><span class="k">public</span><span class="o">:</span></div><div class="line" id="LC4">&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">CNetworkListManagerEvent</span><span class="p">()</span> <span class="o">:</span> <span class="n">m_ref</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div><div class="line" id="LC5">&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">{</span></div><div class="line" id="LC6"><br></div><div class="line" id="LC7">&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class="line" id="LC8"><br></div><div class="line" id="LC9">&nbsp;&nbsp;&nbsp;&nbsp;<span class="o">~</span><span class="n">CNetworkListManagerEvent</span><span class="p">()</span></div><div class="line" id="LC10">&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">{</span></div><div class="line" id="LC11"><br></div><div class="line" id="LC12">&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class="line" id="LC13"><br></div><div class="line" id="LC14">&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">HRESULT</span> <span class="n">STDMETHODCALLTYPE</span> <span class="n">QueryInterface</span><span class="p">(</span><span class="n">REFIID</span> <span class="n">riid</span><span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="n">ppvObject</span><span class="p">)</span></div><div class="line" id="LC15">&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">{</span></div><div class="line" id="LC16">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">HRESULT</span> <span class="n">Result</span> <span class="o">=</span> <span class="n">S_OK</span><span class="p">;</span></div><div class="line" id="LC17">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">if</span> <span class="p">(</span><span class="n">IsEqualIID</span><span class="p">(</span><span class="n">riid</span><span class="p">,</span> <span class="n">IID_IUnknown</span><span class="p">))</span></div><div class="line" id="LC18">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">{</span></div><div class="line" id="LC19">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="o">*</span><span class="n">ppvObject</span> <span class="o">=</span> <span class="p">(</span><span class="n">IUnknown</span> <span class="o">*</span><span class="p">)</span><span class="k">this</span><span class="p">;</span></div><div class="line" id="LC20">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class="line" id="LC21">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IsEqualIID</span><span class="p">(</span><span class="n">riid</span> <span class="p">,</span><span class="n">IID_INetworkListManagerEvents</span><span class="p">))</span></div><div class="line" id="LC22">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">{</span></div><div class="line" id="LC23">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="o">*</span><span class="n">ppvObject</span> <span class="o">=</span> <span class="p">(</span><span class="n">INetworkListManagerEvents</span> <span class="o">*</span><span class="p">)</span><span class="k">this</span><span class="p">;</span></div><div class="line" id="LC24">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class="line" id="LC25">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">else</span></div><div class="line" id="LC26">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">{</span></div><div class="line" id="LC27">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Result</span> <span class="o">=</span> <span class="n">E_NOINTERFACE</span><span class="p">;</span></div><div class="line" id="LC28">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class="line" id="LC29"><br></div><div class="line" id="LC30">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">return</span> <span class="n">Result</span><span class="p">;</span></div><div class="line" id="LC31">&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class="line" id="LC32"><br></div><div class="line" id="LC33">&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">ULONG</span> <span class="n">STDMETHODCALLTYPE</span> <span class="n">AddRef</span><span class="p">()</span></div><div class="line" id="LC34">&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">{</span></div><div class="line" id="LC35">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">return</span> <span class="p">(</span><span class="n">ULONG</span><span class="p">)</span><span class="n">InterlockedIncrement</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m_ref</span><span class="p">);</span></div><div class="line" id="LC36">&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class="line" id="LC37"><br></div><div class="line" id="LC38">&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">ULONG</span> <span class="n">STDMETHODCALLTYPE</span> <span class="n">Release</span><span class="p">()</span></div><div class="line" id="LC39">&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">{</span></div><div class="line" id="LC40">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">LONG</span> <span class="n">Result</span> <span class="o">=</span> <span class="n">InterlockedDecrement</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m_ref</span><span class="p">);</span></div><div class="line" id="LC41">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">if</span> <span class="p">(</span><span class="n">Result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span></div><div class="line" id="LC42">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">delete</span> <span class="k">this</span><span class="p">;</span></div><div class="line" id="LC43">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">return</span> <span class="p">(</span><span class="n">ULONG</span><span class="p">)</span><span class="n">Result</span><span class="p">;</span></div><div class="line" id="LC44">&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class="line" id="LC45"><br></div><div class="line" id="LC46">&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">virtual</span> <span class="n">HRESULT</span> <span class="n">STDMETHODCALLTYPE</span> <span class="n">ConnectivityChanged</span><span class="p">(</span></div><div class="line" id="LC47">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cm">/* [in] */</span> <span class="n">NLM_CONNECTIVITY</span> <span class="n">newConnectivity</span><span class="p">)</span></div><div class="line" id="LC48">&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">{</span></div><div class="line" id="LC49">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">return</span> <span class="n">S_OK</span><span class="p">;</span></div><div class="line" id="LC50">&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class="line" id="LC51"><br></div><div class="line" id="LC52"><span class="k">private</span><span class="o">:</span></div><div class="line" id="LC53"><br></div><div class="line" id="LC54">&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">LONG</span> <span class="n">m_ref</span><span class="p">;</span></div><div class="line" id="LC55"><span class="p">};</span></div><div class="line" id="LC56"><br></div><div class="line" id="LC57"><span class="kt">int</span> <span class="n">_tmain</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="n">TCHAR</span><span class="o">**</span> <span class="n">argv</span><span class="p">,</span> <span class="n">TCHAR</span><span class="o">**</span> <span class="n">Env</span><span class="p">)</span></div><div class="line" id="LC58"><span class="p">{</span></div><div class="line" id="LC59">&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">CoInitialize</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>    </div><div class="line" id="LC60"><br></div><div class="line" id="LC61">&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">//</span></div><div class="line" id="LC62">&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">//  通过NLA接口获取网络状态</span></div><div class="line" id="LC63">&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">//</span></div><div class="line" id="LC64">&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">IUnknown</span> <span class="o">*</span><span class="n">pUnknown</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span></div><div class="line" id="LC65"><br></div><div class="line" id="LC66">&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">HRESULT</span> <span class="n">Result</span> <span class="o">=</span> <span class="n">CoCreateInstance</span><span class="p">(</span><span class="n">CLSID_NetworkListManager</span><span class="p">,</span> </div><div class="line" id="LC67">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="nb">NULL</span><span class="p">,</span> <span class="n">CLSCTX_ALL</span><span class="p">,</span> <span class="n">IID_IUnknown</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pUnknown</span><span class="p">);</span></div><div class="line" id="LC68">&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">if</span> <span class="p">(</span><span class="n">SUCCEEDED</span><span class="p">(</span><span class="n">Result</span><span class="p">))</span></div><div class="line" id="LC69">&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">{</span></div><div class="line" id="LC70">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">INetworkListManager</span> <span class="o">*</span><span class="n">pNetworkListManager</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span></div><div class="line" id="LC71">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Result</span> <span class="o">=</span> <span class="n">pUnknown</span><span class="o">-&gt;</span><span class="n">QueryInterface</span><span class="p">(</span><span class="n">IID_INetworkListManager</span><span class="p">,</span> </div><div class="line" id="LC72">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pNetworkListManager</span><span class="p">);</span></div><div class="line" id="LC73">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">if</span> <span class="p">(</span><span class="n">SUCCEEDED</span><span class="p">(</span><span class="n">Result</span><span class="p">))</span></div><div class="line" id="LC74">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">{</span></div><div class="line" id="LC75">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">VARIANT_BOOL</span> <span class="n">IsConnect</span> <span class="o">=</span> <span class="n">VARIANT_FALSE</span><span class="p">;</span></div><div class="line" id="LC76">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Result</span> <span class="o">=</span> <span class="n">pNetworkListManager</span><span class="o">-&gt;</span><span class="n">get_IsConnectedToInternet</span><span class="p">(</span><span class="o">&amp;</span><span class="n">IsConnect</span><span class="p">);</span></div><div class="line" id="LC77">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">if</span> <span class="p">(</span><span class="n">SUCCEEDED</span><span class="p">(</span><span class="n">Result</span><span class="p">))</span></div><div class="line" id="LC78">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">{</span></div><div class="line" id="LC79">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">printf</span><span class="p">(</span><span class="s">"IsConnect Result %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">IsConnect</span> <span class="o">==</span> <span class="n">VARIANT_TRUE</span> <span class="o">?</span> <span class="s">"TRUE"</span> <span class="o">:</span> <span class="s">"FALSE"</span><span class="p">);</span></div><div class="line" id="LC80">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class="line" id="LC81"><br></div><div class="line" id="LC82">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">IConnectionPointContainer</span> <span class="o">*</span><span class="n">pCPContainer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span></div><div class="line" id="LC83">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Result</span> <span class="o">=</span> <span class="n">pNetworkListManager</span><span class="o">-&gt;</span><span class="n">QueryInterface</span><span class="p">(</span><span class="n">IID_IConnectionPointContainer</span><span class="p">,</span></div><div class="line" id="LC84">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pCPContainer</span><span class="p">);</span></div><div class="line" id="LC85">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">if</span> <span class="p">(</span><span class="n">SUCCEEDED</span><span class="p">(</span><span class="n">Result</span><span class="p">))</span></div><div class="line" id="LC86">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">{</span></div><div class="line" id="LC87">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">IConnectionPoint</span> <span class="o">*</span><span class="n">pConnectPoint</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span></div><div class="line" id="LC88">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Result</span> <span class="o">=</span> <span class="n">pCPContainer</span><span class="o">-&gt;</span><span class="n">FindConnectionPoint</span><span class="p">(</span><span class="n">IID_INetworkListManagerEvents</span><span class="p">,</span> </div><div class="line" id="LC89">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="o">&amp;</span><span class="n">pConnectPoint</span><span class="p">);</span></div><div class="line" id="LC90">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">if</span><span class="p">(</span><span class="n">SUCCEEDED</span><span class="p">(</span><span class="n">Result</span><span class="p">))</span></div><div class="line" id="LC91">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">{</span></div><div class="line" id="LC92">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">DWORD</span> <span class="n">Cookie</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span></div><div class="line" id="LC93">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">CNetworkListManagerEvent</span> <span class="o">*</span><span class="n">NetEvent</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CNetworkListManagerEvent</span><span class="p">;</span></div><div class="line" id="LC94">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Result</span> <span class="o">=</span> <span class="n">pConnectPoint</span><span class="o">-&gt;</span><span class="n">Advise</span><span class="p">((</span><span class="n">IUnknown</span> <span class="o">*</span><span class="p">)</span><span class="n">NetEvent</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Cookie</span><span class="p">);</span></div><div class="line" id="LC95">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">if</span> <span class="p">(</span><span class="n">SUCCEEDED</span><span class="p">(</span><span class="n">Result</span><span class="p">))</span></div><div class="line" id="LC96">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">{</span></div><div class="line" id="LC97">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">printf</span><span class="p">(</span><span class="s">"Loop Message</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span></div><div class="line" id="LC98">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">MSG</span> <span class="n">msg</span><span class="p">;</span></div><div class="line" id="LC99">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">while</span><span class="p">(</span><span class="n">GetMessage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span></div><div class="line" id="LC100">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">{</span></div><div class="line" id="LC101">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">TranslateMessage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span></div><div class="line" id="LC102">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">DispatchMessage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span></div><div class="line" id="LC103"><br></div><div class="line" id="LC104">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">message</span> <span class="o">==</span> <span class="n">WM_QUIT</span><span class="p">)</span></div><div class="line" id="LC105">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">{</span></div><div class="line" id="LC106">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">break</span><span class="p">;</span></div><div class="line" id="LC107">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class="line" id="LC108">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class="line" id="LC109"><br></div><div class="line" id="LC110">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">pConnectPoint</span><span class="o">-&gt;</span><span class="n">Unadvise</span><span class="p">(</span><span class="n">Cookie</span><span class="p">);</span></div><div class="line" id="LC111"><br></div><div class="line" id="LC112">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">pConnectPoint</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">();</span></div><div class="line" id="LC113">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class="line" id="LC114">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class="line" id="LC115"><br></div><div class="line" id="LC116">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">pCPContainer</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">();</span></div><div class="line" id="LC117">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class="line" id="LC118"><br></div><div class="line" id="LC119">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">pNetworkListManager</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">();</span></div><div class="line" id="LC120">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class="line" id="LC121"><br></div><div class="line" id="LC122">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">pUnknown</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">();</span></div><div class="line" id="LC123">&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class="line" id="LC124"><br></div><div class="line" id="LC125">&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">CoUninitialize</span><span class="p">();</span></div><div class="line" id="LC126">&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">return</span> <span class="mi">1</span><span class="p">;</span></div><div class="line" id="LC127"><span class="p">}</span></div></pre></div>
          </div>

          <div class="gist-meta">
            <a href="https://gist.github.com/raw/3747800/95c2562c7782c5d3ef195883bddc92544809e0e8/network_change.cpp" style="float:right;">view raw</a>
            <a href="https://gist.github.com/3747800#file_network_change.cpp" style="float:right;margin-right:10px;color:#666">network_change.cpp</a>
            <a href="https://gist.github.com/3747800">This Gist</a> brought to you by <a href="http://github.com">GitHub</a>.
          </div>
        </div>
</div>


<p>
因为NLA API是WINDOWS VISTA之后才有的，对于WINDOWS XP是不兼容的，但是WINDOWS XP下有一个方法可以达到同样的效果，可以参考文章<a href="http://msdn.microsoft.com/en-us/library/ms700657(v=vs.85">Network Awareness in Windows XP</a>.aspx)，这个文章里的代码是C#的，其中关键的代码转换成C++:</p>

<div id="gist-3747803" class="gist">
        <div class="gist-file">
          <div class="gist-data gist-syntax">
              <div class="gist-highlight"><pre><div class="line" id="LC1"><span class="kt">void</span> <span class="n">WaitForNetworkChnages</span><span class="p">()</span></div><div class="line" id="LC2"><span class="p">{</span></div><div class="line" id="LC3"><br></div><div class="line" id="LC4">&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">WSAQUERYSET</span> <span class="n">querySet</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span></div><div class="line" id="LC5">&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">querySet</span><span class="p">.</span><span class="n">dwSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">WSAQUERYSET</span><span class="p">);</span></div><div class="line" id="LC6">&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">querySet</span><span class="p">.</span><span class="n">dwNameSpace</span> <span class="o">=</span> <span class="n">NS_NLA</span><span class="p">;</span></div><div class="line" id="LC7"><br></div><div class="line" id="LC8">&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">HANDLE</span> <span class="n">LookupHandle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span></div><div class="line" id="LC9">&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">WSALookupServiceBegin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">querySet</span><span class="p">,</span> <span class="n">LUP_RETURN_ALL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">LookupHandle</span><span class="p">);</span></div><div class="line" id="LC10">&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">DWORD</span> <span class="n">BytesReturned</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></div><div class="line" id="LC11">&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">WSANSPIoctl</span><span class="p">(</span><span class="n">LookupHandle</span><span class="p">,</span> <span class="n">SIO_NSP_NOTIFY_CHANGE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">BytesReturned</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span></div><div class="line" id="LC12">&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">WSALookupServiceEnd</span><span class="p">(</span><span class="n">LookupHandle</span><span class="p">);</span></div><div class="line" id="LC13"><span class="p">}</span></div><div class="line" id="LC14"><br></div><div class="line" id="LC15"><span class="kt">void</span> <span class="n">Test</span><span class="p">()</span></div><div class="line" id="LC16"><span class="p">{</span></div><div class="line" id="LC17"><br></div><div class="line" id="LC18">&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">WSAData</span> <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span></div><div class="line" id="LC19">&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">WSAStartup</span><span class="p">(</span><span class="n">MAKEWORD</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span></div><div class="line" id="LC20">&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></div><div class="line" id="LC21">&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div><div class="line" id="LC22">&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">{</span></div><div class="line" id="LC23">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">printf</span><span class="p">(</span><span class="s">"BeginWait %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">);</span></div><div class="line" id="LC24">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">WaitForNetworkChnages</span><span class="p">();</span></div><div class="line" id="LC25">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">printf</span><span class="p">(</span><span class="s">"EndWait</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span></div><div class="line" id="LC26">&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span></div><div class="line" id="LC27"><br></div><div class="line" id="LC28">&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">WSACleanup</span><span class="p">();</span></div><div class="line" id="LC29"><span class="p">}</span>  </div></pre></div>
          </div>

          <div class="gist-meta">
            <a href="https://gist.github.com/raw/3747803/f988328af4c516c69419cf05facee0fe42f61e07/network_change_by_nla_socket.cpp" style="float:right;">view raw</a>
            <a href="https://gist.github.com/3747803#file_network_change_by_nla_socket.cpp" style="float:right;margin-right:10px;color:#666">network_change_by_nla_socket.cpp</a>
            <a href="https://gist.github.com/3747803">This Gist</a> brought to you by <a href="http://github.com">GitHub</a>.
          </div>
        </div>
</div>


</div>
 
<div id="related">
  <h2>Related Posts</h2>
  <ul class="posts">
    
      <li><span>27 Sep 2012</span> - <a href="/2012/09/27/iocp.html">IOCP Internals</a></li>
    
      <li><span>16 Sep 2012</span> - <a href="/2012/09/16/begin.html">新的开始</a></li>
    
      <li><span>25 Apr 2012</span> - <a href="/2012/04/25/open-registry-key-in-regedit-exe.html">Open registry key in regedit.exe</a></li>
    
      <li><span>19 Apr 2012</span> - <a href="/2012/04/19/analyze-dead-lock.html">一次死锁的分析</a></li>
    
      <li><span>05 Mar 2012</span> - <a href="/2012/03/05/use_declspec_thread_in_dll.html">Use __declspec(thread) in dll occured Exception</a></li>
    
  </ul>
</div>


<br />
<br />
<hr />
<div id="comments">
  <h2>Comments</h2>
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_identifier = "/2012/04/23/How-to-Get-Network-Change-automation.html";
    (function() {
     var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
     dsq.src = 'http://eahydra.disqus.com/embed.js';
     (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript=eahydra">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

      </div>
    </div>
  </body>
</html>
